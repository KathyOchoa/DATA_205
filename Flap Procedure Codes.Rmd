---
title: "Flaps Procedure Analysis"
output: html_document
date: "2023-11-27"
---


Necessary libraries
```{r}
library(readxl)
library(tidyverse)
library(dplyr)
library(stringi)
```


Read in the flaps dataset from 2016-2019
```{r}
setwd("/Users/kathyochoa/Documents/DATA_205/Project/Flaps_CSV")
flaps2016 <- read.csv("2016_Flap.csv", na = c("", "NA"))
flaps2017 <- read.csv("2017_Flap.csv", na = c("", "NA"))
flaps2018 <- read.csv("2018_Flap.csv", na = c("", "NA"))
flaps2019 <- read.csv("2019_Flap.csv", na = c("", "NA"))
```


Read in the excel sheet with all the necessary codes
```{r}
flap_Codes <- read_excel("Timing to Flap Procedure Codes.xlsx")
fracture_Codes <- read_excel("Timing to Flap Procedure Codes.xlsx", 2)
fixation_Codes <- read_excel("Timing to Flap Procedure Codes.xlsx", 3)
```


##### Data Wrangling ##### 

Spreadsheets
```{r}
# Rename code columns names
colnames(flap_Codes)[1] <-"code"
colnames(flap_Codes)[2] <- "description"
colnames(fracture_Codes)[1] <- "code"
colnames(fracture_Codes)[2] <- "description"
colnames(fixation_Codes)[1] <- "code"
colnames(fixation_Codes)[2] <- "description"

# Merge the spreadsheets
codesOfInterest <- full_join(flap_Codes, fixation_Codes, 
                             by = c("code", "description")) %>%
  full_join(fracture_Codes, by = c("code", "description"))

# Remove white space or extra characters in code columns
codesOfInterest$code <- gsub("`", '', codesOfInterest$code, fixed = TRUE)
codesOfInterest$code <- stri_trim_both(codesOfInterest$code)
```


Flaps 2016 - 2019 dataframes
```{r}
## Merge Flaps Dataframes based on common columns

# comCols used to merge flaps2016 and flaps2017
# comCols2 used to merge flaps2016/2017 and 2018/2019

comCols1 <- intersect(names(flaps2016), names(flaps2017))
comCols2 <- intersect(names(flaps2018), names(flaps2019))

# Full join the 4 dataframes

allYears <- flaps2016 %>%
  full_join(flaps2017, by = comCols1) %>%
  full_join(flaps2018, by = comCols2) %>%
  full_join(flaps2019, by = comCols2)

head(allYears)
```

Check the summary of allYears
```{r}
summary(allYears)
```

Replace any negative values with NA's
```{r}
allYears[allYears < 0] <- NA
```

Check the summary once again
```{r}
summary(allYears)
```


## All Diagnostic and Procedure Codes ##
```{r}
# Select all the columns of interest
myCols <- allYears %>%
  select(age, amonth, aweekend, died, dispuniform, elective, female, 
         hcup_division, i10_ndx, i10_npr, los, pay1, race, totchg, 
         year, zipinc_qrtl, contains("i10_dx"), contains("i10_pr"))

head(myCols)
```

Elongate diagnostic and procedure columns
```{r}
dpLong <- pivot_longer(myCols, cols = contains("i10_dx") | contains("i10_pr"))

head(dpLong)
```

Group by codes used each year
Only look at the codes of interest based on prefix or from spreadsheet:
Fixation: Upper (0PH) and Lower (0QH)
Transfer: Skin & Breast (0HX) and Tissue & Fascia (0JX)
```{r}
myCodes <- dpLong %>%
  group_by(year, value, zipinc_qrtl) %>%
  filter(value != "I10") %>%
  na.omit() %>%
  filter(grepl("0HX|0JX|0PH|0QH", value) |
         value %in% fracture_Codes$code) %>%
  summarize(count = n(),
            avgAge = round(mean(age)),
            avgNdx = round(mean(i10_ndx)),
            avgNpr = round(mean(i10_npr)),
            avgChg = round(mean(totchg)),
            avgLos = round(mean(los))
            ) %>%
  mutate(type = case_when(
    grepl("0PH", value) ~ "Upper Fixation",
    grepl("0QH", value) ~ "Lower Fixation",
    grepl("0HX", value) ~ "Skin & Breast Transfer",
    grepl("0JX", value) ~ "Tissue & Fascia Transfer"
  ))

head(myCodes)
```

Clean up myCodes and merge with codesOfInterest
```{r}
# Rename code column in myCodes
colnames(myCodes)[2] <- "code"

# Remove white space from the codes
myCodes$code <- stri_trim_both(myCodes$code)

# Merge flapcodes and skinTansfer to get the desciption of codes
finalCodes <- left_join(myCodes, codesOfInterest, by = "code")
```


```{r}
#write.csv(finalCodes, "Types of Flaps.csv")
```


```{r}

```


```{r}

```


```{r}

```


```{r}

```


```{r}

```


```{r}

```

