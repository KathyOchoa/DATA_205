---
title: "Flaps Procedure Analysis"
output: html_document
date: "2023-11-27"
---

##### Data Ingestion ##### 

Necessary libraries
```{r}
library(readxl)
library(tidyverse)
library(dplyr)
library(stringi)
```


Read in the flaps dataset from 2016-2019
```{r}
setwd("/Users/kathyochoa/Documents/DATA_205/Project/Flaps_CSV")
flaps2016 <- read.csv("2016_Flap.csv", na = c("", "NA"))
flaps2017 <- read.csv("2017_Flap.csv", na = c("", "NA"))
flaps2018 <- read.csv("2018_Flap.csv", na = c("", "NA"))
flaps2019 <- read.csv("2019_Flap.csv", na = c("", "NA"))
```


Read in the excel sheet with all the necessary codes
```{r}
setwd("/Users/kathyochoa/Documents/DATA_205/Project/Flaps_CSV")
flap_Codes <- read_excel("Timing to Flap Procedure Codes.xlsx")
fracture_Codes <- read_excel("Timing to Flap Procedure Codes.xlsx", 2)
fixation_Codes <- read_excel("Timing to Flap Procedure Codes.xlsx", 3)
```


##### Data Wrangling ##### 

Spreadsheets
```{r}
# Rename code columns names
colnames(flap_Codes)[1] <-"value"
colnames(flap_Codes)[2] <- "description"
colnames(fracture_Codes)[1] <- "value"
colnames(fracture_Codes)[2] <- "description"
colnames(fixation_Codes)[1] <- "value"
colnames(fixation_Codes)[2] <- "description"

# Merge the spreadsheets
codesOfInterest <- full_join(flap_Codes, fixation_Codes, 
                             by = c("value", "description")) %>%
  full_join(fracture_Codes, by = c("value", "description"))

# Remove white space or extra characters in code columns
codesOfInterest$value <- gsub("`", '', codesOfInterest$value, fixed = TRUE)
codesOfInterest$value <- stri_trim_both(codesOfInterest$value)
```


Flaps 2016 - 2019 dataframes
```{r}
## Merge Flaps Dataframes based on common columns

# comCols used to merge flaps2016 and flaps2017
# comCols2 used to merge flaps2016/2017 and 2018/2019

comCols1 <- intersect(names(flaps2016), names(flaps2017))
comCols2 <- intersect(names(flaps2018), names(flaps2019))

# Full join the 4 dataframes

allYears <- flaps2016 %>%
  full_join(flaps2017, by = comCols1) %>%
  full_join(flaps2018, by = comCols2) %>%
  full_join(flaps2019, by = comCols2)

head(allYears)
```

Check the summary of allYears
```{r}
summary(allYears)
```

Replace any negative values with NA's
```{r}
allYears[allYears < 0] <- NA
```

Check the summary once again
```{r}
summary(allYears)
```


## All Diagnostic and Procedure Codes ##
```{r}
# Select all the columns of interest
myCols <- allYears %>%
  select(age, amonth, aweekend, died, dispuniform, elective, female, 
         hcup_division, i10_ndx, i10_npr, key_nis, los, pay1, race, totchg, 
         year, zipinc_qrtl, contains("i10_dx"), contains("i10_pr"))

head(myCols)
```

Elongate diagnostic and procedure columns
```{r}
dpLong <- pivot_longer(myCols, cols = contains("i10_dx") | contains("i10_pr"))

head(dpLong)
```


Only look at the codes of interest based on prefix or from spreadsheet:
Fixation: Upper (0PH) and Lower (0QH)
Transfer: Skin & Breast (0HX) and Tissue & Fascia (0JX)
Fracture: List from spreadsheet
```{r}
myCodes <- dpLong %>%
  filter(str_starts(value, "0HX|0JX|0PH|0QH") |
         value %in% fracture_Codes$value) %>%
  mutate(type = case_when(
    grepl("0PH", value) ~ "Upper Fixation",
    grepl("0QH", value) ~ "Lower Fixation",
    grepl("0HX", value) ~ "Skin & Breast Transfer",
    grepl("0JX", value) ~ "Tissue & Fascia Transfer",
    value %in% fracture_Codes$value ~ "Fracture"
  ))

head(myCodes)
```

Clean up myCodes and merge with codesOfInterest
```{r}
# Remove white space from the codes
myCodes$value <- stri_trim_both(myCodes$value)

# Merge flapcodes and skinTansfer to get the desciption of codes
finalCodes <- left_join(myCodes, codesOfInterest, by = "value")
```


```{r}
write.csv(finalCodes, "Types of Flaps.csv")
```


Create a new dataframe with categorical variables
```{r}
categDf <- myCodes %>%
  select(amonth, aweekend, died, dispuniform, elective, female, 
         hcup_division, pay1, race, year, zipinc_qrtl)

head(categDf)
```

Rename categorical variables
```{r}
## Categorize amonth ##
for(i in 1:length(month.name)) {
  categDf$amonth[categDf$amonth == i] <- month.name[i]
}

# Reorder the months in consecutive order
categDf$amonth <- factor(categDf$amonth, levels = month.name)


## Categorize aweekend ##
categDf$aweekend[categDf$aweekend == 0] <- "Mon-Fri"
categDf$aweekend[categDf$aweekend == 1] <- "Sat-Sun"


## Categorize died ##
categDf$died[categDf$died == 0] <- "Did not die"
categDf$died[categDf$died == 1] <- "Died"


## Categorize dispuniform ##
dispUni <- c("Routine", "Transfer to short-term hospital", "Transfer Other",
             "Home Health Care", "Against medical advice", "Died in hospital",
             "Discharged/transferred to court/law enforcement",
             "Discharged alive, destination unknown")

categDf$dispuniform[categDf$dispuniform == 1] <- dispUni[1]
categDf$dispuniform[categDf$dispuniform == 2] <- dispUni[2]
categDf$dispuniform[categDf$dispuniform == 5] <- dispUni[3]
categDf$dispuniform[categDf$dispuniform == 6] <- dispUni[4]
categDf$dispuniform[categDf$dispuniform == 7] <- dispUni[5]
categDf$dispuniform[categDf$dispuniform == 20] <- dispUni[6]
categDf$dispuniform[categDf$dispuniform == 21] <- dispUni[7]
categDf$dispuniform[categDf$dispuniform == 99] <- dispUni[8]

# Reorder disposition
categDf$dispuniform <- factor(categDf$dispuniform, levels = dispUni)


## Categorize elective ##
categDf$elective[categDf$elective == 0] <- "Non-elective"
categDf$elective[categDf$elective == 1] <- "Elective"


## Categorize female ##
categDf$female[categDf$female == 0] <- "Male"
categDf$female[categDf$female == 1] <- "Female"


## Categorize hcup_division ##
hospDiv <- c("New England", "Middle Atlantic", "East North Central",
             "West North Central", "South Atlantic", "East South Central",
             "West South Central", "Mountain", "Pacific")
for (i in 1:length(hospDiv)) {
  categDf$hcup_division[categDf$hcup_division == i] <- hospDiv[i]
}
# Reorder hcup_division
categDf$hcup_division <- factor(categDf$hcup_division, levels = hospDiv)


## Categorize pay1 ##
pay <- c("Medicare", "Medicaid", "Private insurance", 
         "Self-pay", "No charge", "Other")

for (i in 1:length(pay)) {
  categDf$pay1[categDf$pay1 == i] <- pay[i]
}

# Reorder pay1
categDf$pay1 <- factor(categDf$pay1, levels = pay)


## Categorize race ##
race <- c("White", "Black", "Hispanic", "Asian or Pacific Islander",
          "Native American", "Other")

for (i in 1:length(race)) {
  categDf$race[categDf$race == i] <- race[i]
}

# Reorder race
categDf$race <- factor(categDf$race, levels = race)


## Categorize zipinc_qrtl ##
incQt <- c("0-25th percentile", "26th to 50th percentile (median)",
           "51st to 75th percentile", "76th to 100th percentile")
for(i in 1:length(incQt)) {
  categDf$zipinc_qrtl[categDf$zipinc_qrtl == i] <- incQt[i]
}

head(categDf)

```

Change column names
```{r}
colnames(categDf) <- c("Admission Month", "Admission Day", 
                       "Status", "Disposition", "Elective",
                       "Sex", "Hospital Division", "Primary Payer", 
                       "Race", "Year", "Household Income")


head(categDf)
```


#### Exploratory Data Analysis #####

```{r}
freqTab <- categDf %>%
  map(function(x) table(x))

freqTab
```



Look at types of Flaps annually
```{r}
byType <- myCodes %>%
  group_by(type) %>%
  summarize(count = n())

head(byType)
```

```{r}
type_chart <- ggplot(byType, aes(x = year, y = count, color = type)) +
  labs(title = "Types of Flaps Over the Years") +
  geom_line() +
  xlab("Year") +
  ylab("Frequency") +
  geom_point() +
  scale_color_brewer(palette = "Set1") +
  scale_color_discrete(name = "Type of Flap") +
  theme_minimal(base_size = 14)

type_chart
```



```{r}

```


```{r}

```


```{r}

```

