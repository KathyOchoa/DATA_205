---
title: "Flaps Procedure Analysis"
output:
  pdf_document: default
  html_document: default
date: "2023-11-27"
---

##### Data Ingestion ##### 

Necessary libraries
```{r}
library(readxl)
library(tidyverse)
library(dplyr)
library(stringi)
library(tinytex)
library(ggplot2)
```


Read in the flaps dataset from 2016-2019
```{r}
setwd("/Users/kathyochoa/Documents/DATA_205/Project/Flaps_CSV")
flaps2016 <- read.csv("2016_Flap.csv", na = c("", "NA"))
flaps2017 <- read.csv("2017_Flap.csv", na = c("", "NA"))
flaps2018 <- read.csv("2018_Flap.csv", na = c("", "NA"))
flaps2019 <- read.csv("2019_Flap.csv", na = c("", "NA"))
```


Read in the excel sheet with all the necessary codes
```{r}
setwd("/Users/kathyochoa/Documents/DATA_205/Project/Flaps_CSV")
fracture_Codes <- read_excel("Timing to Flap Procedure Codes.xlsx", 2)
flap_Codes <- read_excel("Timing to Flap Procedure Codes.xlsx")

fixation_Codes <- read_excel("Timing to Flap Procedure Codes.xlsx", 3)
```


##### Data Wrangling ##### 

Rename the columns of the Excel Spreadsheets then merge 
them to create one sheet of codes
```{r}
# Rename code columns names
colnames(flap_Codes)[1] <-"value"
colnames(flap_Codes)[2] <- "description"
colnames(fracture_Codes)[1] <- "value"
colnames(fracture_Codes)[2] <- "description"
colnames(fixation_Codes)[1] <- "value"
colnames(fixation_Codes)[2] <- "description"

# Merge the spreadsheets
codesOfInterest <- full_join(flap_Codes, fixation_Codes, 
                             by = c("value", "description")) %>%
  full_join(fracture_Codes, by = c("value", "description"))

# Remove white space or extra characters in code columns
codesOfInterest$value <- gsub("`", '', codesOfInterest$value, fixed = TRUE)
codesOfInterest$value <- stri_trim_both(codesOfInterest$value)
```


Merge the Flaps 2016 - 2019 dataframes
```{r}
# comCols used to merge flaps2016 and flaps2017
# comCols2 used to merge flaps2016/2017 and 2018/2019

comCols1 <- intersect(names(flaps2016), names(flaps2017))
comCols2 <- intersect(names(flaps2018), names(flaps2019))

# Full join the 4 dataframes

allYears <- flaps2016 %>%
  full_join(flaps2017, by = comCols1) %>%
  full_join(flaps2018, by = comCols2) %>%
  full_join(flaps2019, by = comCols2)

head(allYears)
```

Check the summary of allYears
```{r}
summary(allYears)
```

Replace any negative values with NA's
```{r}
allYears[allYears < 0] <- NA
```

Check the summary once again
```{r}
summary(allYears)
```


## All Diagnostic and Procedure Codes ##

Select all the columns of interest
```{r}
dxPr <- allYears %>%
  select(year, contains("i10_dx"), contains("i10_pr"))

head(dxPr)
```

Lengthen the diagnostic and procedure columns
```{r}
dpLong <- pivot_longer(dxPr, cols = -(year))

# Remove white space from the codes
dpLong$value <- stri_trim_both(dpLong$value)

head(dpLong)
```


Look at the codes of interest based on prefix or from spreadsheet:
Fixation: Upper (0PH) and Lower (0QH)
Transfer: Skin & Breast (0HX) and Tissue & Fascia (0JX)
Fracture: List from spreadsheet
If not a fracture related code, set type to "other"
```{r}
myCodes <- dpLong %>%
  filter(value != "I10") %>%
  na.omit() %>%
  mutate(type = case_when(
    str_starts(value, "0PH") ~ 1,
    str_starts(value, "0QH") ~ 2,
    str_starts(value, "0HX") ~ 3,
    str_starts(value, "0JX") ~ 4,
    value %in% fracture_Codes$value ~ 5,
    .default = 6
  )) %>%
  mutate(procedure = case_when(
    type == 1 ~ "Upper Fixation",
    type == 2 ~ "Lower Fixation",
    type == 3 ~ "Skin & Breast Transfer",
    type == 4 ~ "Tissue & Fascia Transfer",
    type == 5 ~ "Fracture Diagnostic",
    type == 6 ~ "Other"
  ))

head(myCodes)
```

```{r}
onlyFracture <- myCodes %>%
  group_by(year) %>%
  filter(type == 5) %>%
  summarize(count = n())

head(onlyFracture)
```



Create a new dataframe with categorical variables
```{r}
categDf <- allYears %>%
  select(amonth, aweekend, died, dispuniform, dqtr, elective, 
         female, hcup_division, pay1, race, year, zipinc_qrtl)

head(categDf)
```

Rename categorical variables
```{r}
## Categorize amonth ##
for(i in 1:length(month.name)) {
  categDf$amonth[categDf$amonth == i] <- month.name[i]
}

# Reorder the months in consecutive order
categDf$amonth <- factor(categDf$amonth, levels = month.name)


## Categorize aweekend ##
categDf$aweekend[categDf$aweekend == 0] <- "Mon-Fri"
categDf$aweekend[categDf$aweekend == 1] <- "Sat-Sun"


## Categorize died ##
categDf$died[categDf$died == 0] <- "Did not die"
categDf$died[categDf$died == 1] <- "Died"


## Categorize dispuniform ##
dispUni <- c("Routine", "Transfer to short-term hospital", "Transfer Other",
             "Home Health Care", "Against medical advice", "Died in hospital",
             "Discharged/transferred to court/law enforcement",
             "Discharged alive, destination unknown")

categDf$dispuniform[categDf$dispuniform == 1] <- dispUni[1]
categDf$dispuniform[categDf$dispuniform == 2] <- dispUni[2]
categDf$dispuniform[categDf$dispuniform == 5] <- dispUni[3]
categDf$dispuniform[categDf$dispuniform == 6] <- dispUni[4]
categDf$dispuniform[categDf$dispuniform == 7] <- dispUni[5]
categDf$dispuniform[categDf$dispuniform == 20] <- dispUni[6]
categDf$dispuniform[categDf$dispuniform == 21] <- dispUni[7]
categDf$dispuniform[categDf$dispuniform == 99] <- dispUni[8]

# Reorder disposition
categDf$dispuniform <- factor(categDf$dispuniform, levels = dispUni)


## Categorize dqtr ##
disQtr <- c("1st: Jan - Mar", "2nd: Apr - Jun", "3rd: Jul - Sep", "4th: Oct - Dec")
for(i in 1:length(disQtr)) {
  categDf$dqtr[categDf$dqtr == i] <- disQtr[i]
}

# Reorder dqtr
categDf$dqtr <- factor(categDf$dqtr, levels = disQtr)


## Categorize elective ##
categDf$elective[categDf$elective == 0] <- "Non-elective"
categDf$elective[categDf$elective == 1] <- "Elective"


## Categorize female ##
categDf$female[categDf$female == 0] <- "Male"
categDf$female[categDf$female == 1] <- "Female"


## Categorize hcup_division ##
hospDiv <- c("New England", "Middle Atlantic", "East North Central",
             "West North Central", "South Atlantic", "East South Central",
             "West South Central", "Mountain", "Pacific")
for (i in 1:length(hospDiv)) {
  categDf$hcup_division[categDf$hcup_division == i] <- hospDiv[i]
}
# Reorder hcup_division
categDf$hcup_division <- factor(categDf$hcup_division, levels = hospDiv)


## Categorize pay1 ##
pay <- c("Medicare", "Medicaid", "Private insurance", 
         "Self-pay", "No charge", "Other")

for (i in 1:length(pay)) {
  categDf$pay1[categDf$pay1 == i] <- pay[i]
}

# Reorder pay1
categDf$pay1 <- factor(categDf$pay1, levels = pay)


## Categorize race ##
race <- c("White", "Black", "Hispanic", "Asian or Pacific Islander",
          "Native American", "Other")

for (i in 1:length(race)) {
  categDf$race[categDf$race == i] <- race[i]
}

# Reorder race
categDf$race <- factor(categDf$race, levels = race)


## Categorize zipinc_qrtl ##
incQt <- c("0-25th percentile", "26th to 50th percentile (median)",
           "51st to 75th percentile", "76th to 100th percentile")
for(i in 1:length(incQt)) {
  categDf$zipinc_qrtl[categDf$zipinc_qrtl == i] <- incQt[i]
}

# Change the column names
dfColNames <- list("Admission Month", "Admission Day", 
                       "Status", "Disposition", "Discharge Quarter", 
                       "Elective", "Sex", "Hospital Division", 
                       "Primary Payer", "Race", "Year", 
                       "Household Income")
colnames(categDf) <- dfColNames


head(categDf)
```



#### Exploratory Data Analysis #####

# General Plots

*A* Line plot: Annual Incidence
```{r}
annualIncidence <- allYears %>%
  group_by(year) %>%
  summarize(count = n()) 

annualIncidencePlot <- annualIncidence %>% 
  ggplot(aes(x = year, y = count)) +
  ggtitle("Annual Flaps Incidence") +
  theme_minimal(base_size = 12) + 
  geom_line() +
  xlab("Year") +
  ylab("Annual Incidence")  +
  ylim(0,70000)

annualIncidencePlot
```


*D* Line plot: Mean Annual Charge ($)
```{r}
annualCharge <- allYears %>%
  filter(totchg > 0) %>%
  group_by(year) %>%
  summarize(avgCharge = mean(totchg)) 
```

```{r}
annualChargePlot <- annualCharge %>%
  ggplot(aes(x = year, y = avgCharge)) +
  ggtitle("Mean Annual Total Charges of Procedures") +
  theme_minimal(base_size = 12) + 
  geom_line() +
  scale_y_continuous(labels = scales::dollar_format(scale = 0.001, suffix = "K")) +
  xlab("Year") +
  ylab("Mean Annual Charge") +
  expand_limits(y = 0)

annualChargePlot
```


# Procedure Type Plots

Bar chart: frequency of specific fractures
```{r}
byTypeChart <- myCodes %>%
  group_by(procedure) %>%
  filter(procedure != "Other") %>%
  ggplot(aes(procedure, fill = procedure)) +
  geom_bar() +
  labs(title = "Specific Flaps Procedures from 2016-2019") +
  xlab("Procedure Type") +
  ylab("Number of procedures") +
  theme_classic() +
  scale_fill_discrete(name = "Procedure Type") +
  theme(axis.text.x = element_text(face = "bold", 
                                   size = 7, angle = 8))

byTypeChart
```


Side-by-side box plot of fracture types over the years
```{r}
byYearTypeChart <- myCodes %>%
  filter(procedure != "Other") %>%
  ggplot(aes(x=year, fill = procedure)) +
  geom_bar(alpha = 0.5, position = "dodge") +
  labs(title = "Comparing Specific Procedure Annually") +
  xlab("Year") +
  ylab("Number of procedures") +
  scale_fill_discrete(name = "Procedure Type") +
  theme_minimal()

byYearTypeChart
```


# Patient Demographics Plots

Box plots of race vs age
```{r}
# Create a new column for race
allYears <- allYears %>%
  mutate(raceStr = case_when(
    race == 1 ~ "White",
    race == 2 ~ "Black",
    race == 3 ~ "Hispanic",
    race == 4 ~ "Asian or Pacific Islander",
    race == 5 ~ "Native American",
    .default = "Other"
  ))

raceList <- c("White", "Black", "Hispanic", "Asian or Pacific Islander",
          "Native American", "Other")

# Reorder the Races
allYears$raceStr <- factor(allYears$raceStr, levels = raceList)

head(allYears)
```

```{r}
plot1 <- ggplot(data = allYears, aes(x = raceStr, y = age, group = raceStr, fill = raceStr)) +
  geom_boxplot() +
  ggtitle("Flap Patient Demographics: Race and Age") +
  xlab("Race") +
  ylab("Age") +
  scale_fill_discrete(name = "Race") +
  theme(axis.text.x = element_text(angle = 25))

plot1
```


Frequency Table
```{r}
freqTab <- sapply(categDf, table)

freqTab
```



### Statistical Analysis ###

# Linear Equation

```{r}
lmFit1 <- lm(count ~ year, data = annualIncidence)
summary(lmFit1)
```

```{r}
lmFit2 <- lm(avgCharge ~ year, data = annualCharge)
summary(lmFit2)
```


# Generalized Linear Model

Is there a relationship between total charge and a patient's demographic?
```{r}
fit1 <- glm(totchg ~ age + race + zipinc_qrtl + female, data = allYears)
summary(fit1)
```


Is there a relationship between total charge and length of stay + number of procedures/diagnoses?
```{r}
fit2 <- glm(totchg ~ i10_ndx + i10_npr + los, data = allYears)
summary(fit2)
```

Since the AIC from fit one is less than the AIC from the second model, 
fit one is the better regression model to fit the data.

# Chi-Squared

Run a chi-squared test to test the likelihood of dying from and elective flaps procedure
```{r}
table(categDf$Elective, categDf$Status)
```

```{r}
chisq.test(categDf$Elective, categDf$Status, correct = F)
```

